import re
import asyncio
from vk_api import VkApi
from vk_api.bot_longpoll import VkBotLongPoll, VkBotEventType
from vk_api.utils import get_random_id

from src.config import settings
from src.utils.logger import get_logger
from src.database import init_db, save_user, save_report
from src.data_sources import get_fake_land_data
from src.rate_limiter import rate_limiter
from src.metrics import metrics

logger = get_logger(__name__)

def send_message(vk: VkApi, peer_id: int, text: str) -> None:
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    try:
        vk.messages.send(
            peer_id=peer_id,
            message=text,
            random_id=get_random_id()
        )
        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è peer_id={peer_id}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

async def handle_start_command(vk: VkApi, user_id: int) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start"""
    await save_user(user_id)
    metrics.increment_command_counter('/start')
    
    welcome_text = """üåç –ü—Ä–∏–≤–µ—Ç! –Ø –ó–µ–º–ª—èVot ‚Äî –±–æ—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–µ–º–µ–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤.

üìù –ß—Ç–æ —è —É–º–µ—é:
‚Ä¢ –ü–æ–ª—É—á–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–º—É –Ω–æ–º–µ—Ä—É
‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä—ã–Ω–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
‚Ä¢ –î–∞–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

üïπ –ù–∞–ø–∏—à–∏—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥."""
    
    send_message(vk, user_id, welcome_text)

async def handle_help_command(vk: VkApi, user_id: int) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /help"""
    metrics.increment_command_counter('/help')
    
    help_text = """üìö –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

/start ‚Äî –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/help ‚Äî –ü–æ–º–æ—â—å
/report <–∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä> ‚Äî –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç

üìã –ü—Ä–∏–º–µ—Ä:
/report 77:01:0001001:123"""
    
    send_message(vk, user_id, help_text)


async def handle_report_command(vk: VkApi, user_id: int, text: str) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /report"""
    metrics.increment_command_counter('/report')
    
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞
    match = re.search(r'\d{2}:\d{2}:\d{7}:\d+', text)
    if not match:
        send_message(vk, user_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞.\n\nüìù –ü—Ä–∏–º–µ—Ä: /report 77:01:0001001:123")
        return
    
    cadastral_number = match.group()
    logger.info(f"–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–∞–¥–∞—Å—Ç—Ä {cadastral_number} –æ—Ç user_id={user_id}")
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    send_message(vk, user_id, "‚è≥ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–∞–Ω–Ω—ã–µ... –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.")
    
    try:
        land_data = await get_fake_land_data(cadastral_number)
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
        await save_report(user_id, cadastral_number, land_data)
        
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
        report = f"""üìä –û—Ç—á–µ—Ç –ø–æ —É—á–∞—Å—Ç–∫—É: {land_data['cadastral_number']}

üìç –ê–¥—Ä–µ—Å: {land_data['address']}
üìè –ü–ª–æ—â–∞–¥—å: {land_data['area_sqm']} –º¬≤
üíº –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {land_data['category']}

üí∞ –¶–µ–Ω—ã:
  ‚Ä¢ –†—ã–Ω–æ—á–Ω–∞—è: {land_data['market_price']:,.0f} ‚ÇΩ
  ‚Ä¢ –ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∞—è: {land_data['cadastral_price']:,.0f} ‚ÇΩ

‚ö†Ô∏è –†–∏—Å–∫–∏: {land_data['risks']}
‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: {land_data['recommendations']}"""
        
        send_message(vk, user_id, report)
        metrics.increment_reports_generated()
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
        send_message(vk, user_id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

async def run_bot():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    await init_db()
    logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    
    try:
        vk_session = VkApi(token=settings.VK_TOKEN)
        vk = vk_session.get_api()
        
        group_info = vk.groups.getById(group_id=settings.VK_GROUP_ID)
        logger.info(f"–ë–æ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –≥—Ä—É–ø–ø–µ: {group_info[0]['name']}")
        
        longpoll = VkBotLongPoll(vk_session, settings.VK_GROUP_ID)
        
        logger.info("üöÄ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...")
        
        for event in longpoll.listen():
            if event.type == VkBotEventType.MESSAGE_NEW:
                user_id = event.obj.message['from_id']
                text = event.obj.message.get('text', '').strip()
                
                if not rate_limiter.check_rate_limit(user_id):
                    vk.messages.send(
                        user_id=user_id,
                        random_id=get_random_id(),
                        message="‚è≥ –í—ã —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ –∑–∞–ø—Ä–æ—Å—ã. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ."
                    )
                    continue
                
                if text.lower() in ['/start', '–Ω–∞—á–∞—Ç—å']:
                    await handle_start_command(vk, user_id)
                elif text.lower() in ['/help', '–ø–æ–º–æ—â—å']:
                    await handle_help_command(vk, user_id)
                elif text.lower().startswith('/report'):
                    await handle_report_command(vk, user_id, text)
                else:
                    vk.messages.send(
                        user_id=user_id,
                        random_id=get_random_id(),
                        message="‚ùì –ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥."
                    )
    
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –±–æ—Ç–∞: {e}")
        raise
