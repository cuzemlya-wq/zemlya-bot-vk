"""–î–∏–∞–ª–æ–≥–æ–≤—ã–µ –ø–æ—Ç–æ–∫–∏ –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—É–ø–µ–Ω—á–∞—Ç–æ–π –≤–æ—Ä–æ–Ω–∫–∏ –ø—Ä–æ–¥–∞–∂"""

from typing import Dict, List, Optional
from dataclasses import dataclass

@dataclass
class DialogStep:
    """–®–∞–≥ –¥–∏–∞–ª–æ–≥–∞"""
    text: str
    buttons: List[Dict[str, str]]
    next_flow: Optional[str] = None

# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
DIALOG_FLOWS = {
    "greeting": DialogStep(
        text="""üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ó–µ–º–ª—è–í–æ—Ç ‚Äî –ø–æ–º–æ–≥–∞—é —Å –∞–Ω–∞–ª–∏–∑–æ–º –∑–µ–º–µ–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤.

–Ø –º–æ–≥—É:
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é —á–∏—Å—Ç–æ—Ç—É —É—á–∞—Å—Ç–∫–∞
‚Ä¢ –û—Ü–µ–Ω–∏—Ç—å —Ä—ã–Ω–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
‚Ä¢ –í—ã—è–≤–∏—Ç—å —Å–∫—Ä—ã—Ç—ã–µ —Ä–∏—Å–∫–∏ –∏ –æ–±—Ä–µ–º–µ–Ω–µ–Ω–∏—è
‚Ä¢ –î–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?""",
        buttons=[
            {"label": "üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—á–∞—Å—Ç–æ–∫", "payload": "check_plot"},
            {"label": "üí∞ –£–∑–Ω–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å", "payload": "pricing"},
            {"label": "‚ùì –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç", "payload": "how_it_works"}
        ]
    ),
    
    "qualification_buyer": DialogStep(
        text="""–û—Ç–ª–∏—á–Ω–æ! –ß—Ç–æ–±—ã –¥–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑, —É—Ç–æ—á–Ω–∏—Ç–µ:

–í—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–∫—É–ø–∫—É —É—á–∞—Å—Ç–∫–∞ –∏–ª–∏ —É–∂–µ —è–≤–ª—è–µ—Ç–µ—Å—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–º?""",
        buttons=[
            {"label": "üè° –ü–ª–∞–Ω–∏—Ä—É—é –∫—É–ø–∏—Ç—å", "payload": "buyer"},
            {"label": "‚úÖ –£–∂–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫", "payload": "owner"},
            {"label": "ü§î –ü—Ä–æ—Å—Ç–æ –∏–∑—É—á–∞—é —Ä—ã–Ω–æ–∫", "payload": "researcher"}
        ]
    ),
    
    "buyer_urgency": DialogStep(
        text="""–ü–æ–Ω—è–ª! –ü–æ–∫—É–ø–∫–∞ –∑–µ–º–ª–∏ ‚Äî —Å–µ—Ä—å—ë–∑–Ω—ã–π —à–∞–≥.

–ù–∞ –∫–∞–∫–æ–π —Å—Ç–∞–¥–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–∞—à–∞ —Å–¥–µ–ª–∫–∞?""",
        buttons=[
            {"label": "‚ö° –£–∂–µ –Ω–∞—à—ë–ª —É—á–∞—Å—Ç–æ–∫", "payload": "urgent"},
            {"label": "üîé –ê–∫—Ç–∏–≤–Ω–æ –∏—â—É", "payload": "active"},
            {"label": "üìã –ü—Ä–∏—Å–º–∞—Ç—Ä–∏–≤–∞—é—Å—å", "payload": "browsing"}
        ]
    ),
    
    "urgent_buyer": DialogStep(
        text="""‚ö†Ô∏è –í–ê–ñ–ù–û! –ü–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1Ô∏è‚É£ –û–±—Ä–µ–º–µ–Ω–µ–Ω–∏—è –∏ –∞—Ä–µ—Å—Ç—ã
2Ô∏è‚É£ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ä–µ–∞–ª—å–Ω—ã–º –≥—Ä–∞–Ω–∏—Ü–∞–º
3Ô∏è‚É£ –°–∫—Ä—ã—Ç—ã–µ –¥–æ–ª–≥–∏ –∏ –Ω–∞–ª–æ–≥–∏
4Ô∏è‚É£ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π

90% –ø—Ä–æ–±–ª–µ–º –≤—ã—è–≤–ª—è—é—Ç—Å—è –Ω–∞ —ç—Ç–∞–ø–µ –ø—Ä–æ–≤–µ—Ä–∫–∏!

–•–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –ë–ï–°–ü–õ–ê–¢–ù–£–Æ —ç–∫—Å–ø—Ä–µ—Å—Å-–ø—Ä–æ–≤–µ—Ä–∫—É –≤–∞—à–µ–≥–æ —É—á–∞—Å—Ç–∫–∞?""",
        buttons=[
            {"label": "‚úÖ –î–∞, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å!", "payload": "request_report"},
            {"label": "üìû –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è", "payload": "consultation"},
            {"label": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "payload": "back"}
        ]
    ),
    
    "pricing": DialogStep(
        text="""üíé –ù–∞—à–∏ —É—Å–ª—É–≥–∏:

üîç –≠–ö–°–ü–†–ï–°–°-–ü–†–û–í–ï–†–ö–ê (–ë–ï–°–ü–õ–ê–¢–ù–û)
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –±–∞–∑–µ –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞
‚Ä¢ –í—ã—è–≤–ª–µ–Ω–∏–µ –æ–±—Ä–µ–º–µ–Ω–µ–Ω–∏–π
‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ 10 –º–∏–Ω—É—Ç

üìä –ë–ê–ó–û–í–´–ô –û–¢–ß–Å–¢ ‚Äî 2.8-3.2 —Ç—ã—Å. ‚ÇΩ
‚Ä¢ –ü–æ–ª–Ω–∞—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
‚Ä¢ –†—ã–Ω–æ—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤
‚Ä¢ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å 1-2 —á–∞—Å–∞

üèÜ –†–ê–°–®–ò–†–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó ‚Äî 5-10 —Ç—ã—Å. ‚ÇΩ
‚Ä¢ –í—Å—ë –∏–∑ –ë–∞–∑–æ–≤–æ–≥–æ
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π
‚Ä¢ –ì—Ä–∞–¥–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
‚Ä¢ –õ–∏—á–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —ç–∫—Å–ø–µ—Ä—Ç–∞

–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?""",
        buttons=[
            {"label": "üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞", "payload": "free_check"},
            {"label": "üìä –ë–∞–∑–æ–≤—ã–π –æ—Ç—á—ë—Ç", "payload": "basic_report"},
            {"label": "üèÜ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π", "payload": "premium_report"},
            {"label": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "payload": "greeting"}
        ]
    ),
    
    "how_it_works": DialogStep(
        text="""üîß –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞:

1Ô∏è‚É£ –í—ã –¥–∞—ë—Ç–µ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞
2Ô∏è‚É£ –ú—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞
3Ô∏è‚É£ –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç 10+ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
4Ô∏è‚É£ –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç—á—ë—Ç

‚è± –≠–∫—Å–ø—Ä–µ—Å—Å-–ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî 10 –º–∏–Ω
üìÑ –ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç ‚Äî 1-2 —á–∞—Å–∞

–í—Å—ë –æ–Ω–ª–∞–π–Ω, –±–µ–∑ –≤–∏–∑–∏—Ç–æ–≤ –≤ –æ—Ñ–∏—Å!

–ü–æ–ø—Ä–æ–±—É–µ–º?""",
        buttons=[
            {"label": "‚úÖ –î–∞, –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å!", "payload": "request_report"},
            {"label": "üí∞ –°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç?", "payload": "pricing"},
            {"label": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "payload": "greeting"}
        ]
    ),
    
    "request_report": DialogStep(
        text="""üìã –û—Ç–ª–∏—á–Ω–æ! –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–Ω–µ –Ω—É–∂–µ–Ω –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞.

–§–æ—Ä–º–∞—Ç: XX:XX:XXXXXXX:XXX
–ü—Ä–∏–º–µ—Ä: 77:01:0001001:123

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É:
/report –í–ê–®_–ö–ê–î–ê–°–¢–†–û–í–´–ô_–ù–û–ú–ï–†

–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞:""",
        buttons=[
            {"label": "üìù –ü—Ä–∏–º–µ—Ä: /report 77:01:0001001:123", "payload": "example_report"},
            {"label": "‚ùì –ì–¥–µ –Ω–∞–π—Ç–∏ –Ω–æ–º–µ—Ä?", "payload": "find_cadastral"},
            {"label": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "payload": "greeting"}
        ]
    ),
    
    "find_cadastral": DialogStep(
        text="""üîç –ì–¥–µ –Ω–∞–π—Ç–∏ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä:

1Ô∏è‚É£ –í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –Ω–∞ —É—á–∞—Å—Ç–æ–∫ (—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ, –¥–æ–≥–æ–≤–æ—Ä)
2Ô∏è‚É£ –ù–∞ —Å–∞–π—Ç–µ –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞ (rosreestr.gov.ru)
3Ô∏è‚É£ –í –≤—ã–ø–∏—Å–∫–µ –ï–ì–†–ù
4Ô∏è‚É£ –ù–∞ –ø—É–±–ª–∏—á–Ω–æ–π –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–π –∫–∞—Ä—Ç–µ

–§–æ—Ä–º–∞—Ç: XX:XX:XXXXXXX:XXX

–ö–æ–≥–¥–∞ –Ω–∞–π–¥—ë—Ç–µ ‚Äî –æ—Ç–ø—Ä–∞–≤—å—Ç–µ:
/report –í–ê–®_–ù–û–ú–ï–†""",
        buttons=[
            {"label": "üìù –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏", "payload": "example_report"},
            {"label": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "payload": "request_report"}
        ]
    ),
    
    "consultation": DialogStep(
        text="""üìû –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —ç–∫—Å–ø–µ—Ä—Ç–∞:

–ù–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç 24/7 –∏ –≥–æ—Ç–æ–≤—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã:

‚Ä¢ –í—ã–±–æ—Ä —É—á–∞—Å—Ç–∫–∞
‚Ä¢ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏
‚Ä¢ –û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
‚Ä¢ –ü–æ—Ä—è–¥–æ–∫ —Å–¥–µ–ª–∫–∏
‚Ä¢ –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏

üí¨ –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –ø—Ä—è–º–æ –∑–¥–µ—Å—å, –∏ —ç–∫—Å–ø–µ—Ä—Ç –æ—Ç–≤–µ—Ç–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 5-10 –º–∏–Ω—É—Ç!

–ò–ª–∏ –∑–∞–∫–∞–∂–∏—Ç–µ –æ–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫:""",
        buttons=[
            {"label": "üìû –ó–∞–∫–∞–∑–∞—Ç—å –∑–≤–æ–Ω–æ–∫", "payload": "callback"},
            {"label": "üìä –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É", "payload": "request_report"},
            {"label": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "payload": "greeting"}
        ]
    ),
    
    "callback": DialogStep(
        text="""üì± –û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫:

–û—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∏ –º—ã –ø–µ—Ä–µ–∑–≤–æ–Ω–∏–º –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç!

–§–æ—Ä–º–∞—Ç: +7 (XXX) XXX-XX-XX

–ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–≤–æ–Ω–∫–∞.""",
        buttons=[
            {"label": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "payload": "consultation"}
        ]
    )
}

def get_dialog_step(flow_name: str) -> Optional[DialogStep]:
    """–ü–æ–ª—É—á–∏—Ç—å —à–∞–≥ –¥–∏–∞–ª–æ–≥–∞ –ø–æ –∏–º–µ–Ω–∏"""
    return DIALOG_FLOWS.get(flow_name)

def format_buttons_for_vk(buttons: List[Dict[str, str]]) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–ª—è VK API (JSON –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)"""
    import json
    
    keyboard = {
        "one_time": False,
        "buttons": []
    }
    
    for button in buttons:
        keyboard["buttons"].append([
            {
                "action": {
                    "type": "text",
                    "label": button["label"],
                    "payload": json.dumps({"button": button["payload"]})
                },
                "color": "primary" if "–î–∞" in button["label"] or "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å" in button["label"].lower() else "secondary"
            }
        ])
    
    return json.dumps(keyboard, ensure_ascii=False)
