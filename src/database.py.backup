import json
from datetime import datetime
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine, async_sessionmaker
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column
from sqlalchemy import String, Integer, DateTime, Text

from src.config import settings
from src.utils.logger import get_logger

logger = get_logger(__name__)

class Base(DeclarativeBase):
    pass

class User(Base):
    __tablename__ = "users"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    vk_user_id: Mapped[int] = mapped_column(Integer, unique=True, nullable=False, index=True)
    first_seen: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    last_activity: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

class Report(Base):
    __tablename__ = "reports"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    user_id: Mapped[int] = mapped_column(Integer, nullable=False, index=True)
    cadastral_number: Mapped[str] = mapped_column(String(50), nullable=False, index=True)
    report_data: Mapped[str] = mapped_column(Text, nullable=False)
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)

engine = create_async_engine(settings.DATABASE_URL, echo=False)
AsyncSessionLocal = async_sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)

async def init_db():
    """Инициализация базы данных"""
    try:
        async with engine.begin() as conn:
            await conn.run_sync(Base.metadata.create_all)
        logger.info("База данных успешно инициализирована")
    except Exception as e:
        logger.warning(f"Ошибка инициализации БД: {e}. Бот продолжит работу без БД.")

async def save_user(vk_user_id: int):
    """Сохранение пользователя"""
    try:
        async with AsyncSessionLocal() as session:
            from sqlalchemy import select
            stmt = select(User).where(User.vk_user_id == vk_user_id)
            result = await session.execute(stmt)
            user = result.scalar_one_or_none()
            
            if user:
                user.last_activity = datetime.utcnow()
                logger.info(f"Обновлена активность пользователя {vk_user_id}")
            else:
                user = User(vk_user_id=vk_user_id)
                session.add(user)
                logger.info(f"Создан новый пользователь {vk_user_id}")
            
            await session.commit()
    except Exception as e:
        logger.error(f"Ошибка сохранения пользователя: {e}")

async def save_report(user_id: int, cadastral_number: str, report_data: dict):
    """Сохранение отчёта"""
    try:
        async with AsyncSessionLocal() as session:
            report = Report(
                user_id=user_id,
                cadastral_number=cadastral_number,
                report_data=json.dumps(report_data, ensure_ascii=False)
            )
            session.add(report)
            await session.commit()
            logger.info(f"Сохранен отчет для {cadastral_number} (заглушка)")
    except Exception as e:
        logger.error(f"Ошибка сохранения отчета: {e}")
